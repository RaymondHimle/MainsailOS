#!/usr/bin/env bash
# MainsailOS Specific Tweaks
# written by Stephan Wendel aka KwadFan
# <me@stephanwe.de>
# GPL V3
########


# Source error handling, leave this in place
set -xe

# Source CustomPIOS common.sh
# shellcheck disable=SC1091
source /common.sh
install_cleanup_trap

# Install armbian specific packages
apt update
# shellcheck disable=SC2086
check_install_pkgs ${ARMBIAN_DEPS}

# unpack and create needed dir's
unpack /filesystem/root /
mkdir -p /var/run/wpa_supplicant

# Disable First Run and remove depending files
# https://github.com/armbian/build/blob/master/packages/bsp/common/usr/lib/armbian/armbian-firstrun-config

# Disable service
systemctl disable armbian-firstrun-config

# remove template
if [[ -f "/boot/armbian_first_run.txt.template" ]]; then
    rm -f /boot/armbian_first_run.txt.template
fi

# Remove first-login script
if [[ -f "/etc/profile.d/armbian-check-first-login.sh" ]]; then
    rm -f /etc/profile.d/armbian-check-first-login.sh
fi

# Purge network-manager
apt purge --yes network-manager

# Do not remove root account yet!
# Must be removed later on!!!
yes 1234 | passwd

# # Create base user
# # Shameless "stolen" from
# # https://github.com/guysoft/CustomPiOS/blob/devel/src/variants/armbian/pre_chroot_script

# password="$(openssl passwd -6 -stdin <<< "${BASE_USER_PASSWORD}")"
# useradd -m -p "${password}" -s /bin/bash "${BASE_USER}"
if_group_exists_run i2c usermod -aG i2c "${BASE_USER}"
usermod -aG video,audio,plugdev,games,netdev,sudo "${BASE_USER}"
